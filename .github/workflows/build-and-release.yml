name: Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read current version
        id: read_version
        run: |
          VERSION=$(cat version.txt)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Current version: $VERSION"

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config set board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          arduino-cli lib install "HTTPClient"
          arduino-cli lib install "HTTPUpdate"
          arduino-cli lib install "Preferences"
          arduino-cli lib install "WiFi"

      - name: Update version in firmware
        run: |
          # Update the version in the firmware code
          sed -i "s/const char\* currentFirmwareVersion = \".*\"/const char\* currentFirmwareVersion = \"$VERSION\"/" esp32_firmware.ino
          echo "Updated firmware version to $VERSION"

      - name: Compile firmware
        run: |
          mkdir -p build
          arduino-cli compile --fqbn esp32:esp32:esp32 --output-dir ./build esp32_firmware.ino

      - name: Prepare firmware binary
        run: |
          cp build/esp32_firmware.ino.bin firmware.bin
          echo "Firmware size:"
          ls -lh firmware.bin

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "ESP32 Firmware v${{ env.VERSION }}"
          body: |
            ## ESP32 Auto-OTA Firmware v${{ env.VERSION }}
            
            **Auto-OTA Features:**
            - Automatic updates every 2 minutes
            - Downloads from: https://github.com/Nasreddiine/esp32_firmware/releases/latest/download/firmware.bin
            - Version checking from GitHub
            
            **Manual Flash:**
            ```bash
            esptool.py --chip esp32 --port COM6 \
              --baud 921600 write_flash 0x10000 firmware.bin
            ```
            
            **Build Info:**
            - Version: ${{ env.VERSION }}
            - Commit: ${{ github.sha }}
            - Built: $(date -u)
          files: |
            firmware.bin
            version.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create latest tag
        run: |
          # Update latest tag to point to this release
          git tag -f latest
          git push origin latest -f

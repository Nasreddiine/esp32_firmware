name: Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Read version.txt
      # -----------------------------
      - name: Read version.txt
        id: read_version
        run: |
          VERSION=$(cat version.txt | tr -d ' \t\r\n')
          if [ -z "$VERSION" ]; then
            echo "ERROR: version.txt is empty"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=v$VERSION" >> $GITHUB_ENV
          echo "Firmware version: $VERSION"

      # -----------------------------
      # 3. Install arduino-cli
      # -----------------------------
      - name: Install arduino-cli
        run: |
          # Create directory and install
          mkdir -p ~/arduino-cli
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=~/arduino-cli sh
          
          # Add to PATH
          echo "$HOME/arduino-cli" >> $GITHUB_PATH
          
          # Verify
          ~/arduino-cli/arduino-cli version

      # -----------------------------
      # 4. Setup ESP32
      # -----------------------------
      - name: Setup ESP32
        run: |
          ~/arduino-cli/arduino-cli config init
          ~/arduino-cli/arduino-cli config set board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          ~/arduino-cli/arduino-cli core update-index
          ~/arduino-cli/arduino-cli core install esp32:esp32

      # -----------------------------
      # 5. Update firmware version
      # -----------------------------
      - name: Update firmware version
        run: |
          # First, backup the original
          cp esp32_firmware.ino esp32_firmware.ino.backup
          
          # Update the version in the code
          sed -i "s/const char\* currentFirmwareVersion = \".*\"/const char\* currentFirmwareVersion = \"${{ env.VERSION }}\"/" esp32_firmware.ino
          
          # Verify the change
          echo "Updated version to ${{ env.VERSION }}"
          grep -n "currentFirmwareVersion" esp32_firmware.ino

      # -----------------------------
      # 6. Compile firmware
      # -----------------------------
      - name: Compile firmware
        run: |
          # Create build directory
          mkdir -p build
          
          # Compile with verbose output
          ~/arduino-cli/arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --warnings all \
            --verbose \
            --output-dir ./build \
            esp32_firmware.ino 2>&1 | tail -50
          
          echo "Compilation attempt completed"

      # -----------------------------
      # 7. Check build result
      # -----------------------------
      - name: Check build result
        run: |
          if [ -f "build/esp32_firmware.ino.bin" ]; then
            echo "âœ… Build successful!"
            ls -lh build/esp32_firmware.ino.bin
          else
            echo "âŒ Build failed - checking for errors"
            # Try to find any .bin files
            find . -name "*.bin" -type f
            exit 1
          fi

      # -----------------------------
      # 8. Prepare release
      # -----------------------------
      - name: Prepare release
        run: |
          mkdir -p release
          
          # Copy the binary
          cp build/esp32_firmware.ino.bin release/firmware.bin
          
          # Create version-specific copy
          cp release/firmware.bin release/firmware_${{ env.VERSION }}.bin
          
          # Create README
          cat > release/README.md << EOF
          # ESP32 Firmware v${{ env.VERSION }}
          
          ## Features
          - Automatic OTA updates every 2 minutes
          - Version checking from GitHub
          - Secure firmware download and installation
          
          ## Installation
          1. For first time: Flash \`firmware.bin\` to ESP32
          2. For updates: ESP32 will auto-update
          
          ## Manual Flashing
          \`\`\`bash
          esptool.py --chip esp32 --port /dev/ttyUSB0 \\
            --baud 921600 write_flash 0x10000 firmware.bin
          \`\`\`
          
          Build ID: ${{ github.run_id }}
          Commit: ${{ github.sha }}
          EOF
          
          # Show files
          echo "ðŸ“¦ Release files:"
          ls -la release/

      # -----------------------------
      # 9. Create GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "ESP32 Firmware v${{ env.VERSION }}"
          body: |
            ## ESP32 Auto-OTA Firmware v${{ env.VERSION }}
            
            **Features:**
            - Automatic updates every 2 minutes
            - Direct download from GitHub Releases
            - Safe OTA installation
            
            **Files included:**
            - \`firmware.bin\` - Main firmware binary
            - \`firmware_${{ env.VERSION }}.bin\` - Versioned copy
            
            **Build Information:**
            - Build ID: ${{ github.run_id }}
            - Commit: ${{ github.sha }}
            - Built: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            
            ---
            *Automated build from GitHub Actions*
          draft: false
          prerelease: false
          files: |
            release/firmware.bin
            release/firmware_${{ env.VERSION }}.bin
            release/README.md
            version.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

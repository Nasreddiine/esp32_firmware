name: Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read version
        run: |
          VERSION=$(cat version.txt | tr -d ' \t\r\n')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Current version: $VERSION"

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config set board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          arduino-cli lib install "WiFi"
          arduino-cli lib install "HTTPClient"
          arduino-cli lib install "Preferences"

      - name: Update firmware version
        run: |
          sed -i "s/const char\* currentFirmwareVersion = \".*\"/const char\* currentFirmwareVersion = \"$VERSION\"/" esp32_firmware.ino
          echo "Updated to version $VERSION"

      - name: Compile firmware
        run: |
          mkdir -p build
          arduino-cli compile --fqbn esp32:esp32:esp32 --output-dir ./build esp32_firmware.ino

      - name: Prepare release
        run: |
          cp build/esp32_firmware.ino.bin firmware.bin
          echo "Firmware created:"
          ls -lh firmware.bin

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "ESP32 Firmware v${{ env.VERSION }}"
          body: |
            ESP32 Auto-OTA Firmware v${{ env.VERSION }}
            
            Flash using:
            esptool.py --chip esp32 --port COM6 --baud 921600 write_flash 0x10000 firmware.bin
            
            WiFi: INPT-Test
            Auto-updates every 2 minutes
          files: |
            firmware.bin
            version.txt

      - name: Update latest tag
        run: |
          git tag -f latest
          git push origin latest -f

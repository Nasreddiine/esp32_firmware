name: Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read version.txt
        run: |
          VERSION=$(cat version.txt | tr -d ' \t\r\n')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Firmware version: $VERSION"

      - name: Install arduino-cli
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          export PATH="$PWD/bin:$PATH"
          echo "$PWD/bin" >> $GITHUB_PATH
          arduino-cli version

      - name: Install ESP32 Arduino core
        run: |
          arduino-cli config init
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: Compile firmware
        run: |
          FQBN="esp32:esp32:esp32"
          arduino-cli compile \
            --fqbn $FQBN \
            --output-dir build \
            ./main

          ls -la build

      - name: Prepare firmware.bin
        run: |
          BIN=$(find build -name "*.bin" | head -n 1)
          cp "$BIN" firmware.bin
          ls -la firmware.bin

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.VERSION }}
          name: ESP32 Firmware v${{ env.VERSION }}
          files: firmware.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

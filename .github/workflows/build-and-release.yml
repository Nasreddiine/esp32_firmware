name: Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Read version.txt
      # -----------------------------
      - name: Read version.txt
        id: read_version
        run: |
          VERSION=$(cat version.txt | tr -d ' \t\r\n')
          if [ -z "$VERSION" ]; then
            echo "ERROR: version.txt is empty"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=v$VERSION" >> $GITHUB_ENV
          echo "Firmware version: $VERSION"

      # -----------------------------
      # 3. Install arduino-cli (FIXED)
      # -----------------------------
      - name: Install arduino-cli
        run: |
          # Create bin directory first
          mkdir -p ~/.local/bin
          
          # Install arduino-cli using the official method
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=~/.local/bin sh
          
          # Add to PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify installation
          ~/.local/bin/arduino-cli version

      # -----------------------------
      # 4. Add ESP32 board support
      # -----------------------------
      - name: Add ESP32 board URL
        run: |
          ~/.local/bin/arduino-cli config init --overwrite
          ~/.local/bin/arduino-cli config set board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      # -----------------------------
      # 5. Install ESP32 core
      # -----------------------------
      - name: Install ESP32 Arduino core
        run: |
          ~/.local/bin/arduino-cli core update-index
          ~/.local/bin/arduino-cli core install esp32:esp32
          
          # List installed cores to verify
          ~/.local/bin/arduino-cli core list

      # -----------------------------
      # 6. Update version in source code
      # -----------------------------
      - name: Update firmware version in source
        run: |
          # Update the version in the Arduino code
          sed -i "s/const char\* currentFirmwareVersion = \".*\"/const char\* currentFirmwareVersion = \"${{ env.VERSION }}\"/" esp32_firmware.ino
          echo "Updated firmware version to ${{ env.VERSION }}"

      # -----------------------------
      # 7. Compile firmware
      # -----------------------------
      - name: Compile firmware
        run: |
          # Create build directory
          mkdir -p build
          
          # Compile the sketch with ESP32 board
          ~/.local/bin/arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --output-dir build \
            esp32_firmware.ino
          
          echo "Compilation completed"
          
          # List build files
          echo "Build files:"
          ls -la build/

      # -----------------------------
      # 8. Prepare release files
      # -----------------------------
      - name: Prepare release files
        run: |
          # Find the compiled binary
          if [ -f "build/esp32_firmware.ino.bin" ]; then
            echo "Found binary: build/esp32_firmware.ino.bin"
            
            # Create release directory
            mkdir -p release
            
            # Copy and rename binary
            cp build/esp32_firmware.ino.bin release/firmware.bin
            cp build/esp32_firmware.ino.bin release/firmware_${{ env.VERSION }}.bin
            
            # Create info file
            echo "Firmware Version: ${{ env.VERSION }}" > release/build_info.txt
            echo "Build Date: $(date)" >> release/build_info.txt
            echo "Commit SHA: ${{ github.sha }}" >> release/build_info.txt
            
            # List release files
            echo "Release files:"
            ls -la release/
            
            echo "Binary size:"
            ls -lh release/firmware.bin
          else
            echo "ERROR: Binary not found!"
            echo "Build directory contents:"
            ls -la build/
            exit 1
          fi

      # -----------------------------
      # 9. Create GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "ESP32 Firmware v${{ env.VERSION }}"
          body: |
            ## ESP32 Auto-OTA Firmware v${{ env.VERSION }}
            
            This firmware includes automatic Over-The-Air (OTA) update functionality.
            
            ### Features:
            - âœ… Automatic version checking every 2 minutes
            - âœ… One-click OTA updates
            - âœ… Safe installation with verification
            - âœ… Version tracking in flash memory
            
            ### How to use:
            1. **First time**: Flash `firmware.bin` to your ESP32
            2. **Updates**: ESP32 will automatically check and install new versions
            
            ### Manual flashing (if needed):
            ```bash
            esptool.py --chip esp32 --port /dev/ttyUSB0 \
              --baud 921600 write_flash 0x10000 firmware.bin
            ```
            
            ### File details:
            - `firmware.bin` - Main firmware for OTA updates
            - `firmware_${{ env.VERSION }}.bin` - Version-specific copy
            - `build_info.txt` - Build information
            
            ---
            *Automatically built from GitHub Actions*
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            release/firmware.bin
            release/firmware_${{ env.VERSION }}.bin
            release/build_info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 10. Post-build verification
      # -----------------------------
      - name: Verify release
        run: |
          echo "âœ… Release v${{ env.VERSION }} created successfully!"
          echo "ðŸ“Ž Download URL: https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/firmware.bin"

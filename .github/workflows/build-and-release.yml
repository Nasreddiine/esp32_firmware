name: Build and Release ESP32 Firmware (PlatformIO)

on:
  push:
    branches: [ main ]
    paths:
      - 'esp32_firmware.ino'
      - 'version.txt'
      - '.github/workflows/build-and-release.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Read version
      run: |
        VERSION=$(cat version.txt | tr -d '[:space:]')
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        echo "TAG_NAME=v${VERSION}" >> $GITHUB_ENV

    - name: Setup PlatformIO
      uses: platformio/platformio-core-action@v1
      with:
        platform: espressif32

    - name: Update version in source code
      run: |
        sed -i "s/const char\* currentFirmwareVersion = \".*\"/const char\* currentFirmwareVersion = \"$VERSION\"/" esp32_firmware.ino

    - name: Create PlatformIO project structure
      run: |
        mkdir -p src
        cp esp32_firmware.ino src/main.cpp
        cat > platformio.ini << EOF
        [env:esp32dev]
        platform = espressif32
        board = esp32dev
        framework = arduino
        upload_speed = 921600
        monitor_speed = 115200
        build_flags = 
            -D ARDUINO_USB_MODE=1
            -D ARDUINO_USB_CDC_ON_BOOT=1
        EOF

    - name: Build with PlatformIO
      run: |
        pio run

    - name: Prepare artifacts
      run: |
        mkdir -p artifacts
        cp .pio/build/esp32dev/firmware.bin artifacts/firmware.bin
        cp .pio/build/esp32dev/firmware.bin artifacts/firmware_${VERSION}.bin
        cp version.txt artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-v${VERSION}
        path: artifacts/

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: firmware-v${{ env.VERSION }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: "ESP32 Firmware v${{ env.VERSION }}"
        files: |
          firmware.bin
          firmware_${{ env.VERSION }}.bin
          version.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

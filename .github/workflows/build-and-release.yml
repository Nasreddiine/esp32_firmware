name: Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Read current version from version.txt
      - name: Read version
        id: read_version
        run: |
          VERSION=$(cat version.txt | tr -d ' \t\r\n')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=v$VERSION" >> $GITHUB_ENV
          echo "Current version: $VERSION"

      # 3. Setup Arduino CLI
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      # 4. Install ESP32 platform and libraries (FIXED - using correct library names)
      - name: Install ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config set board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          # Install required libraries with correct names
          arduino-cli lib install "WiFi"
          arduino-cli lib install "HTTPClient"
          arduino-cli lib install "Preferences"

      # 5. Update firmware version in code
      - name: Update firmware version in code
        run: |
          # Update the version in the firmware code
          sed -i "s/const char\* currentFirmwareVersion = \".*\"/const char\* currentFirmwareVersion = \"${{ env.VERSION }}\"/" esp32_firmware.ino
          echo "Updated firmware version to ${{ env.VERSION }}"
          echo "Updated line:"
          grep "currentFirmwareVersion" esp32_firmware.ino

      # 6. Compile firmware
      - name: Compile firmware
        run: |
          mkdir -p build
          echo "Compiling firmware..."
          arduino-cli compile --fqbn esp32:esp32:esp32 --output-dir ./build esp32_firmware.ino
          echo "Compilation completed!"

      # 7. Prepare release files
      - name: Prepare release
        run: |
          # Check if binary was created
          if [ -f "build/esp32_firmware.ino.bin" ]; then
            echo "✅ Binary found!"
            cp build/esp32_firmware.ino.bin firmware.bin
            ls -lh firmware.bin
            
            # Create a simple README for the release
            cat > README_release.md << EOF
            # ESP32 Firmware v${{ env.VERSION }}
            
            ## Manual Installation
            Flash using esptool:
            \`\`\`bash
            esptool.py --chip esp32 --port COM6 \
              --baud 921600 write_flash 0x10000 firmware.bin
            \`\`\`
            
            ## Auto-OTA Features
            - WiFi: INPT-Test
            - Auto-update every 2 minutes
            - Secure HTTPS downloads
            - Version tracking in Preferences
            
            Build ID: ${{ github.run_id }}
            Commit: ${{ github.sha }}
            EOF
          else
            echo "❌ Binary not found! Listing build directory:"
            find build -type f
            exit 1
          fi

      # 8. Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "ESP32 Firmware v${{ env.VERSION }}"
          body: |
            ## ESP32 Auto-OTA Firmware v${{ env.VERSION }}
            
            **Initial Release** - Flash this manually using Arduino IDE or esptool.
            
            ### Manual Flashing Instructions:
            1. **Using Arduino IDE:**
               - Open `esp32_firmware.ino`
               - Select Board: `ESP32 Dev Module`
               - Select Port: `COM6` (or your port)
               - Click Upload
            
            2. **Using esptool:**
               ```bash
               esptool.py --chip esp32 --port COM6 \
                 --baud 921600 write_flash 0x10000 firmware.bin
               ```
            
            ### Auto-OTA Features:
            - WiFi: INPT-Test
            - Auto-update check: Every 2 minutes
            - Secure HTTPS downloads from GitHub
            - Version tracking in Preferences
            
            **Build Information:**
            - Version: ${{ env.VERSION }}
            - Commit: ${{ github.sha }}
            - Build ID: ${{ github.run_id }}
            - Built: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            ---
            *Automatically built and released by GitHub Actions*
          draft: false
          prerelease: false
          files: |
            firmware.bin
            version.txt
            README_release.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9. Create/Update latest tag for OTA
      - name: Update latest tag
        run: |
          # Update latest tag to point to this release
          git tag -f latest
          git push origin latest -f

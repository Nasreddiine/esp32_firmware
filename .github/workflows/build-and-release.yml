name: Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # 2. Read and increment version
      # -----------------------------
      - name: Bump version
        id: bump_version
        run: |
          # Read current version
          CURRENT_VERSION=$(cat version.txt | tr -d ' \t\r\n')
          echo "Current version: $CURRENT_VERSION"
          
          # Parse version parts
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          
          # Increment patch version
          NEW_PATCH=$((patch + 1))
          NEW_VERSION="$major.$minor.$NEW_PATCH"
          
          # Update version.txt
          echo "$NEW_VERSION" > version.txt
          
          echo "New version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=v$NEW_VERSION" >> $GITHUB_ENV
          
          # Update git config
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Commit version change
          git add version.txt
          git commit -m "Bump version to $NEW_VERSION" || echo "No changes to commit"
          git push origin main

      # -----------------------------
      # 3. Install arduino-cli
      # -----------------------------
      - name: Install arduino-cli
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH

      # -----------------------------
      # 4. Setup ESP32 platform
      # -----------------------------
      - name: Setup ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config set board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          arduino-cli lib install "Preferences"
          arduino-cli lib install "HTTPClient"
          arduino-cli lib install "WiFi"

      # -----------------------------
      # 5. Update firmware version in code
      # -----------------------------
      - name: Update firmware version in code
        run: |
          # Update version in source code
          sed -i "s/const char\* currentFirmwareVersion = \".*\"/const char\* currentFirmwareVersion = \"${{ env.VERSION }}\"/" esp32_firmware.ino
          
          echo "Updated firmware version to ${{ env.VERSION }}"
          grep -n "currentFirmwareVersion" esp32_firmware.ino

      # -----------------------------
      # 6. Compile firmware
      # -----------------------------
      - name: Compile firmware
        run: |
          # Create build directory
          mkdir -p build
          
          # Compile with specific flash mode and size
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --build-property "compiler.cpp.extra_flags=-DAPP_VERSION=\\\"${{ env.VERSION }}\\\"" \
            --export-binaries \
            --output-dir ./build \
            esp32_firmware.ino
          
          echo "Compilation completed"

      # -----------------------------
      # 7. Rename and prepare single firmware.bin
      # -----------------------------
      - name: Prepare firmware binary
        run: |
          # Find and rename the main firmware binary
          if [ -f "build/esp32_firmware.ino.bin" ]; then
            cp build/esp32_firmware.ino.bin firmware.bin
            echo "✅ Main firmware binary prepared"
            ls -lh firmware.bin
          else
            echo "❌ Main firmware binary not found"
            # Try to find any firmware binary
            find build -name "*.bin" -type f
            exit 1
          fi

      # -----------------------------
      # 8. Create release with single binary
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "ESP32 Firmware v${{ env.VERSION }}"
          body: |
            ## ESP32 Auto-OTA Firmware v${{ env.VERSION }}
            
            **Built:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            **Commit:** ${{ github.sha }}
            **Build ID:** ${{ github.run_id }}
            
            ### Installation
            
            #### Manual Flashing (First Time Only)
            ```bash
            esptool.py --chip esp32 --port /dev/ttyUSB0 \
              --baud 921600 --before default_reset \
              --after hard_reset write_flash 0x10000 firmware.bin
            ```
            
            #### Auto-OTA Features
            - Device will auto-update every 2 minutes
            - Certificate-secured HTTPS download
            - Version tracking in Preferences
            - WiFi: INPT-Test
            
            ### Files
            - `firmware.bin` - Main firmware binary (flash at 0x10000)
            - `version.txt` - Current version file
            
            ---
            *Automatically built and released by GitHub Actions*
          draft: false
          prerelease: false
          files: |
            firmware.bin
            version.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 9. Update latest release tag
      # -----------------------------
      - name: Update latest tag
        run: |
          # Delete old latest tag if exists
          git tag -d latest 2>/dev/null || true
          git push --delete origin latest 2>/dev/null || true
          
          # Create new latest tag pointing to current commit
          git tag latest
          git push origin latest

name: CI - Build & Release ESP32 Firmware

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    name: Build (arduino-cli) and create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version.txt into env
        id: read_version
        run: |
          if [ ! -f version.txt ]; then
            echo "version.txt not found!"
            exit 1
          fi
          VERSION=$(cat version.txt | tr -d ' \t\n\r')
          if [ -z "$VERSION" ]; then
            echo "version.txt is empty!"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Read version: $VERSION"

      - name: Install arduino-cli
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          sudo mv ~/bin/arduino-cli /usr/local/bin/arduino-cli
          arduino-cli version

      - name: Configure arduino-cli and install esp32 core
        run: |
          arduino-cli config init
          arduino-cli core update-index
          # Install Espressif ESP32 Arduino core
          arduino-cli core install esp32:esp32
          arduino-cli core list

      - name: Compile sketch (arduino-cli)
        run: |
          # adjust FQBN if you use a different esp32 board; this is a common generic one
          FQBN="esp32:esp32:esp32"
          # compile the sketch in repo root (assumes your .ino is in repo root)
          arduino-cli compile --fqbn $FQBN --output-dir build .
          # show produced files
          ls -la build || true

      - name: Find & rename produced .bin to firmware.bin
        run: |
          BIN=$(ls build/*.bin 2>/dev/null | head -n1)
          if [ -z "$BIN" ]; then
            echo "No .bin produced in build/ - failing"
            ls -la build || true
            exit 1
          fi
          echo "Found binary: $BIN"
          cp "$BIN" firmware.bin
          echo "Created firmware.bin"
          ls -la firmware.bin

      - name: Create GitHub Release and upload firmware.bin
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.VERSION }}
          name: esp32_firmware_v${{ env.VERSION }}
          body: "Automated release for firmware version ${{ env.VERSION }} (generated by CI)."
          files: firmware.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
